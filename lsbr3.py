import wave
import numpy as np

def read_wav(filename):
    """读取WAV文件"""
    with wave.open(filename, 'rb') as f:
        params = f.getparams()
        data = f.readframes(params[3])
    return params, np.frombuffer(data, dtype=np.int16)

def write_wav(filename, params, data):
    """写入WAV文件"""
    with wave.open(filename, 'wb') as f:
        f.setparams(params)
        f.writeframes(data)

def read_txt(filename):
    """读取txt文件内容"""
    with open(filename, 'r') as f:
        return f.read()

def write_txt(filename, content):
    """写入txt文件内容"""
    with open(filename, 'w') as f:
        f.write(content)

def encode_text_to_binary(txt):
    """将txt文件内容编码为二进制"""
    binary = ''.join(format(ord(c), '08b') for c in txt)
    return binary

def decode_binary_to_text(binary):
    """将二进制解码为txt文件内容"""
    txt = ''.join(chr(int(binary[i:i+8], 2)) for i in range(0, len(binary), 8))
    return txt

def lsbr_embed(data, message):
    """LSBR算法嵌入消息到数据中"""
    cover_samples = np.random.choice(len(data), size=len(message), replace=False)
    stego_data = np.copy(data)
    for i, bit in enumerate(message):
        sample_index = cover_samples[i]
        stego_data[sample_index] = (data[sample_index] & 0xfffe) | int(bit)
    return stego_data, cover_samples

def lsbr_extract(data, cover_samples, num_bits):
    """LSBR算法从数据中提取消息"""
    message = ''
    for i in cover_samples:
        message += str(data[i] & 1)
    return message[:num_bits]


def maincode(wav,txt,newwav):
    #多行注释出现错误前面加r就可以
    r"""

    wav=r'D:\多媒体\uiyj3\svega.wav'
    txt='1.txt'
    newwav='stego1.wav'
    """
   
   
    params, data = read_wav(wav)

    # 读取txt文件内容,并将其编码为二进制格式
    txt_content = read_txt(txt)
    binary_message = encode_text_to_binary(txt_content)

    # 嵌入二进制消息到音频数据中
    stego_data, cover_samples = lsbr_embed(data, binary_message)

    # 将嵌入消息后的音频数据写入WAV文件
    write_wav(newwav, params, stego_data)
    print(cover_samples.tolist())

    print(len(binary_message))






def maindecode(wav,cover_samples1,num,txt):
    """
    wav='stego1.wav'
    cover_samples1
    num
    txt='extracted.txt'
    """
    params, stego_data1=read_wav(wav)
    #cover_samples1=[487693, 440337, 877655, 260284, 153438, 246215, 359221, 37062, 490263, 759929, 526624, 20042, 547700, 458061, 627219, 795580, 472920, 618616, 23891, 630261, 814123, 502715, 187029, 284243, 714053, 905139, 591115, 568864, 342301, 821138, 600580, 170271, 911132, 497217, 610598, 359754, 660388, 876446, 68416, 164134, 111505, 680875, 785108, 177261, 219922, 624250, 510624, 116929, 199762, 404152, 187596, 244638, 142455, 889948, 871971, 106905, 758447, 413628, 607722, 377500, 605630, 818493, 189236, 372907, 902401, 80965, 671371, 135921, 418796, 845859, 558407, 198118, 633037, 206974, 371871, 774643, 20864, 385995, 156156, 171857, 185794, 724457, 71156, 691345, 736719, 456606, 408956, 429522, 145552, 399736, 190666, 136950, 270184, 292393, 127858, 137297, 470449, 143311, 204419, 858958, 164249, 469169, 177356, 426560, 115552, 784338, 48936, 307699, 877494, 197231, 223729, 93323, 905021, 830727, 141062, 428936, 695309, 143327, 907485, 37975, 908916, 598469, 536705, 726153, 679425, 597494, 8324, 793863, 909267, 790791, 425525, 492597, 827395, 896479, 242838, 18592, 223168, 209294, 900592, 691244, 687517, 207741, 389335, 516942, 181076, 599581, 688720, 329303, 452354, 857060, 785829, 674722, 483290, 223668, 132370, 309290, 839125, 496562, 652141, 835817, 412623, 822388, 527239, 354407, 239391, 256561, 52725, 37736, 344903, 84487, 435820, 839489, 225175, 842215, 907143, 13966, 273999, 718681, 177072, 692969, 836970, 910867, 195148, 137613, 101360, 621364, 84665, 673447, 88091, 40465, 705246, 748699, 220969, 399886, 690828, 307182, 745073, 26133, 597344, 160485, 25973, 52521, 368709, 536276, 653177, 53336, 493888, 251024, 779967, 114828, 434888, 498793, 505695, 666363, 604528, 526715, 763663, 647568, 355608, 758002, 313388, 795187, 489490, 394577, 808002, 104747, 303376, 130836, 860411, 75417, 216023, 176342, 339687, 429345, 463994, 508351, 796903, 905119, 150343, 43104, 780700, 103440, 777554, 179582, 182802, 513150, 494788, 242488, 872179, 608230, 212505, 390211, 9298, 410351, 621916, 378911, 302964, 611056, 822229, 336188, 684290, 691922, 605512, 616104, 842863, 365250, 709525, 615058, 401868, 846708, 894323, 227886, 284479, 415848, 197430, 738333, 476373, 408845, 815769, 522175, 766631, 670916, 311003, 11154, 887560, 476529, 53394, 890538, 481422, 430153, 141632, 376528, 317885, 834049, 403411, 598320]
   
    # 从嵌入消息后的音频数据中提取出二进制消息，并将其解码为txt文件内容
    extracted_message = lsbr_extract(stego_data1, cover_samples1, num)
    extracted_txt_content = decode_binary_to_text(extracted_message)

    # 将提取的txt文件内容写入文件
    write_txt(txt, extracted_txt_content)
    print(extracted_txt_content)


r"""
wav='svega.wav'
txt='1.txt'
newwav='stego1.wav'

maincode(wav,txt,newwav)
"""




wav='stego1.wav'
cover_samples1=[843382, 33324, 371716, 626472, 182320, 605572, 500651, 624302, 284237, 780439, 291785, 282133, 788933, 485266, 345297, 67680, 872511, 44245, 644257, 323625, 336538, 164777, 731499, 182142, 698153, 687078, 359745, 578591, 432929, 506661, 610468, 181714, 783103, 520056, 163297, 751477, 680011, 638434, 221092, 621639, 436872, 454463, 235795, 768471, 179716, 38311, 778958, 739251, 604913, 668613, 750053, 639669, 467909, 284635, 405692, 141396, 412725, 272456, 888714, 115704, 7246, 420251, 872149, 690507, 211661, 289025, 683774, 245865, 646962, 139838, 351206, 804812, 56888, 610756, 328958, 275292, 320699, 507769, 707207, 683955, 413345, 848785, 461345, 385911, 903723, 693029, 593790, 260236, 80059, 499706, 705850, 821158, 381747, 798262, 772238, 580238, 450023, 807614, 59320, 906816, 532555, 359070, 787640, 312764, 603921, 35660, 26122, 625691, 33465, 723559, 399653, 729187, 784923, 446436, 905169, 574736, 345381, 193988, 341365, 24684, 214146, 73526, 754065, 2849, 472273, 149926, 368381, 106594, 721083, 781802, 91510, 292300, 210660, 177789, 10777, 418860, 533616, 717872, 896098, 574710, 759234, 893353, 875869, 486375, 371725, 75083, 330131, 47419, 908220, 640099, 678151, 206248, 710350, 330621, 416726, 287387, 406788, 602528, 519317, 905267, 721253, 445380, 245484, 803748, 599584, 242258, 85341, 576260, 649558, 742670, 845881, 580226, 322083, 325974, 202036, 676885, 106512, 575514, 633807, 264477, 746060, 797298, 147759, 505844, 634726, 154297, 238656, 606172, 143561, 745003, 898430, 815551, 29709, 385114, 261724, 386920, 244050, 182032, 533933, 574673, 56012, 348915, 565197, 876984, 804359, 712494, 683263, 443843, 717298, 848617, 261146, 837729, 68198, 446030, 523295, 370246, 364340, 820555, 542691, 849519, 377789, 649023, 564297, 431122, 741070, 174736, 704307, 401821, 118565, 481972, 315967, 312973, 730769, 228231, 65293, 267084, 400372, 308027, 894141, 439528, 513885, 677353, 316113, 125964, 573237, 42456, 753263, 450621, 879068, 624757, 190346, 224805, 338174, 120951, 455504, 174434, 797272, 495269, 380992, 300044, 454807, 428551, 381187, 774275, 18380, 298855, 435796, 154995, 193916, 192860, 436034, 357263, 816789, 777045, 570543, 619604, 798562, 499353, 192819, 234176, 329575, 568442, 216389, 572705, 31270, 183023, 677, 808203, 583966, 106174, 123560, 102019, 455914, 685417, 435326, 798005]
num=296
txt='extracted.txt'
maindecode(wav,cover_samples1,num,txt)

